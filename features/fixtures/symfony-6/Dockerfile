ARG PHP_VERSION
FROM php:$PHP_VERSION

WORKDIR /app

ARG BUGSNAG_API_KEY
ARG BUGSNAG_ENDPOINT
ARG BUGSNAG_REDACTED_KEYS
ARG BUGSNAG_DISCARD_CLASSES
ARG BUGSNAG_GUZZLE
ARG BUGSNAG_FEATURE_FLAGS
ARG COMPOSER_GITHUB_TOKEN

ENV BUGSNAG_API_KEY $BUGSNAG_API_KEY
ENV BUGSNAG_ENDPOINT $BUGSNAG_ENDPOINT
ENV BUGSNAG_REDACTED_KEYS $BUGSNAG_REDACTED_KEYS
ENV BUGSNAG_DISCARD_CLASSES $BUGSNAG_DISCARD_CLASSES
ENV BUGSNAG_GUZZLE $BUGSNAG_GUZZLE
ENV BUGSNAG_FEATURE_FLAGS $BUGSNAG_FEATURE_FLAGS
ENV COMPOSER_GITHUB_TOKEN $COMPOSER_GITHUB_TOKEN
ENV BUGSNAG_MEMORY_LIMIT_INCREASE 10485760

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    zip \
    unzip

COPY . .
COPY --from=composer:2.2 /usr/bin/composer /usr/local/bin/composer

RUN sh setup-github-token.sh
RUN php setup-bugsnag-config.php
RUN composer install

CMD ["php", "-S", "0.0.0.0:8000", "-t", "public"]
